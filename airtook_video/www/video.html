{% extends "templates/web.html" %}

{% block title %}{{ page_title or "AirTook Video Consultation" }}{% endblock %}

{% block page_content %}
<div class="container" style="max-width: 1100px; margin-top: 24px; margin-bottom: 48px;">
  <h2 style="margin-bottom: 8px;">Video Consultation</h2>

  {% if invalid %}
    <div class="alert alert-danger">
      Invalid or missing session id. Please use the link provided in your consultation message.
    </div>
  {% else %}

    <div id="status" class="alert alert-info">Preparing your call…</div>

    <div
      id="call-wrap"
      style="display:none; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;"
    >
      <div
        id="daily-frame"
        style="width: 100%; height: 70vh; min-height: 520px;"
      ></div>
    </div>

    <div style="margin-top: 12px; font-size: 13px; color: #6b7280;">
      Session: <code>{{ session_id }}</code>
    </div>

  {% endif %}
</div>

<!-- Daily iframe SDK -->
<script src="https://unpkg.com/@daily-co/daily-js"></script>

<script>
(function () {
  const SESSION_ID = "{{ session_id }}";
  const isGuest = {{ 1 if is_guest else 0 }};

  const urlParams = new URLSearchParams(window.location.search);
  const joinKey = urlParams.get("k"); // magic link key (elderly users)

  const statusEl = document.getElementById("status");
  const callWrap = document.getElementById("call-wrap");
  const frameMount = document.getElementById("daily-frame");

  function setStatus(type, msg) {
    if (!statusEl) return;
    statusEl.className = "alert alert-" + type;
    statusEl.textContent = msg;
  }

  async function getJoinInfo() {
    let url =
      "/api/method/airtook_video.airtook_video.api.get_join_info" +
      "?session_id=" + encodeURIComponent(SESSION_ID);

    // Pass magic key ONLY if present (elderly / WhatsApp flow)
    if (joinKey) {
      url += "&k=" + encodeURIComponent(joinKey);
    }

    const res = await fetch(url, {
      method: "GET",
      credentials: "include",
      headers: { "Accept": "application/json" }
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error("Join info fetch failed (" + res.status + "): " + text);
    }

    const data = await res.json();
    if (!data || !data.message) {
      throw new Error("Invalid response from server");
    }

    return data.message;
  }

  async function start() {
    if (!SESSION_ID) {
      setStatus("danger", "Missing session id.");
      return;
    }

    // Guest WITHOUT magic link → login required (normal flow preserved)
    if (isGuest && !joinKey) {
      setStatus(
        "warning",
        "Please log in to join this consultation."
      );
      return;
    }

    try {
      setStatus("info", "Fetching secure join token…");

      const info = await getJoinInfo();

      if (!info.room_url || !info.token) {
        throw new Error("Invalid meeting details received");
      }

      setStatus("info", "Joining call…");

      const callFrame = window.DailyIframe.createFrame(frameMount, {
        showLeaveButton: true
      });

      callWrap.style.display = "block";

      await callFrame.join({
        url: info.room_url,
        token: info.token,
        userName: info.display_name || "AirTook User"
      });

      setStatus(
        "success",
        "Connected. Please allow camera and microphone access if prompted."
      );

    } catch (err) {
      console.error(err);
      setStatus(
        "danger",
        "Unable to join: " + (err && err.message ? err.message : err)
      );
    }
  }

  start();
})();
</script>
{% endblock %}
