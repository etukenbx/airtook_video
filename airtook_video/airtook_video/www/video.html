<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AirTook Video Consultation</title>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { padding: 16px; max-width: 960px; margin: 0 auto; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; }
    .muted { color: #6b7280; font-size: 14px; }
    #frame { height: 72vh; min-height: 520px; border-radius: 12px; overflow: hidden; background: #0b1020; }
    .error { color: #b91c1c; font-weight: 600; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #111827; background: #111827; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111827; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  </style>

  <!-- Daily JS (CDN) -->
  <script src="https://unpkg.com/@daily-co/daily-js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0;">Video Consultation</h2>
        <span class="muted" id="roleTag"></span>
      </div>
      <p class="muted" style="margin-top:8px;">
        Session: <span id="sid"></span>
      </p>

      <div id="status" class="muted">Connecting…</div>

      <div style="margin-top:12px;" id="actions" class="row"></div>
    </div>

    <div style="height:12px;"></div>

    <div id="frame"></div>
  </div>

  <script>
    const sessionId = "{{ session_id or '' }}";
    const csrfToken = "{{ csrf_token or '' }}";

    document.getElementById("sid").textContent = sessionId || "(missing)";

    function setStatus(msg, isError=false) {
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = isError ? "error" : "muted";
    }

    function addAction(label, onClick, secondary=false) {
      const btn = document.createElement("button");
      btn.textContent = label;
      if (secondary) btn.classList.add("secondary");
      btn.onclick = onClick;
      document.getElementById("actions").appendChild(btn);
    }

    async function postJSON(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Frappe-CSRF-Token": csrfToken
        },
        credentials: "include",
        body: JSON.stringify(payload || {})
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        // If not logged in, Frappe may respond 403/401
        const msg = (data && (data._server_messages || data.exception || data.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }

      return data;
    }

    async function boot() {
      if (!sessionId) {
        setStatus("Missing session_id in URL. Use /video/<session_id>", true);
        return;
      }

      setStatus("Requesting secure join token…");

      try {
        const data = await postJSON("/api/method/airtook_video.airtook_video.api.get_join_info", { session_id: sessionId });
        const info = data.message || data;

        document.getElementById("roleTag").textContent = info.role ? `(${info.role})` : "";

        if (!info.room_url || !info.token) {
          setStatus("Join info incomplete (missing room_url/token).", true);
          return;
        }

        setStatus("Joining call…");

        // Create Daily iframe
        const frame = window.DailyIframe.createFrame(document.getElementById("frame"), {
          showLeaveButton: true,
          iframeStyle: {
            width: "100%",
            height: "100%",
            border: "0",
            borderRadius: "12px"
          }
        });

        frame.join({
          url: info.room_url,
          token: info.token
        });

        // Optional controls
        addAction("Leave Call", () => frame.leave());
        addAction("Reload Page", () => window.location.reload(), true);

        // Events
        frame.on("joined-meeting", () => setStatus("Connected ✅"));
        frame.on("left-meeting", () => setStatus("Call ended."));
        frame.on("error", (e) => setStatus("Daily error: " + (e?.errorMsg || "unknown"), true));

      } catch (err) {
        // Most common: not logged in to portal
        setStatus("Could not join. Make sure you are logged in, then reload. Details: " + err.message, true);

        addAction("Go to Login", () => window.location.href = "/login?redirect-to=" + encodeURIComponent(window.location.pathname));
        addAction("Reload", () => window.location.reload(), true);
      }
    }

    boot();
  </script>
</body>
</html>
